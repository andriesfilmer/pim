#!/usr/bin/env bash

# Function to cleanup processes and their children
cleanup() {
  echo ""
  echo "Shutting down..."

  # Kill CSS watcher and its children
  if [ ! -z "$CSS_PID" ]; then
    pkill -P $CSS_PID 2>/dev/null  # Kill children first
    kill $CSS_PID 2>/dev/null      # Then kill parent
  fi

  # Kill Rails server and its children
  if [ ! -z "$RAILS_PID" ]; then
    pkill -P $RAILS_PID 2>/dev/null  # Kill children first
    kill $RAILS_PID 2>/dev/null      # Then kill parent
  fi

  # Kill SolidQueue worker and its children
  if [ ! -z "$JOBS_PID" ]; then
    pkill -P $JOBS_PID 2>/dev/null  # Kill children first
    kill $JOBS_PID 2>/dev/null      # Then kill parent
  fi

  exit 0
}

# Trap to kill all processes when script exits
trap cleanup INT TERM

# Start CSS watcher in background
bin/rails dartsass:watch &
CSS_PID=$!

# Start SolidQueue worker in background
bin/jobs &
JOBS_PID=$!

# Start Rails server in background
bin/rails server -p 3000 &
RAILS_PID=$!

echo "Started Rails server (PID: $RAILS_PID), CSS watcher (PID: $CSS_PID), and SolidQueue worker (PID: $JOBS_PID)"
echo "Press Ctrl+C to stop"

# Wait for all processes
wait
